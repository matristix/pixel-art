name: Build Aseprite Latest BETA (Linux Only)

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest prerelease
        id: release
        uses: actions-ecosystem/action-get-latest-release@v1
        with:
          repo: aseprite/aseprite
          prerelease: true

      - name: Show release info
        run: echo "Latest prerelease = ${{ steps.release.outputs.tag }}"

      - name: Download source ZIP
        uses: robinraju/release-downloader@v1.11
        with:
          repository: aseprite/aseprite
          tag: ${{ steps.release.outputs.tag }}
          fileName: "Aseprite-.*-Source\.zip"
          regex: true

      - name: Extract source
        run: |
          unzip Aseprite-*-Source.zip
          mv Aseprite-* aseprite

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            cmake ninja-build g++ libc++-dev libc++abi-dev \
            libcurl4-openssl-dev libpixman-1-dev libx11-dev \
            libxcursor-dev libxi-dev libgl1-mesa-dev libfontconfig1-dev

      - name: Build Linux version
        working-directory: aseprite
        run: |
          mkdir build
          cd build
          cmake -DLAF_BACKEND=skia \
                -DSKIA_DIR=$HOME/deps/skia \
                -DSKIA_LIBRARY_DIR=$HOME/deps/skia/out/Release-x64 \
                -G Ninja ..
          ninja

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: aseprite-linux
          path: aseprite/build/bin/*
