name: Build and release Aseprite (Linux only)

on:
  push:
    branches:
      - main
    paths:
      - 'BuildLog.md'
  workflow_dispatch:
env:
  BUILD_TYPE: Release
  PRERELEASE_TAG: "latest-prerelease"  # Fixed tag for always updating the same prerelease

jobs:
  fetch-aseprite-info:
    name: Fetch deps info
    runs-on: ubuntu-latest
    outputs:
      download-link: ${{ steps.aseprite-link.outputs.download-link }}
      release-tag: ${{ steps.aseprite-link.outputs.release-tag }}
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Fetch Aseprite release link
        id: aseprite-link
        uses: a1393323447/fetch-release@main
        with:
            group: aseprite
            repo: aseprite
            match: Aseprite-.*?-Source.zip
      
      - name: Extract version number
        id: extract-version
        run: |
          # Extract version from release tag (e.g., "v1.3" from "v1.3-rc1")
          VERSION=$(echo "${{ steps.aseprite-link.outputs.release-tag }}" | grep -o 'v[0-9]\+\.[0-9]\+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: fetch-aseprite-info
    permissions:
      contents: write
    outputs:
      download-link: ${{ needs.fetch-aseprite-info.outputs.download-link }}
      release-tag: ${{ env.PRERELEASE_TAG }}
      aseprite-version: ${{ needs.fetch-aseprite-info.outputs.version }}
    steps:
      - uses: actions/checkout@v2
      - uses: ncipollo/release-action@v1
        with:
          # Use a fixed tag that will be overwritten each time
          tag: ${{ env.PRERELEASE_TAG }}
          # Include the actual Aseprite version in the body
          body: |
            Aseprite ${{ needs.fetch-aseprite-info.outputs.version }}
            Built from source: ${{ needs.fetch-aseprite-info.outputs.release-tag }}
            Built on: ${{ github.event.head_commit.timestamp || github.run_started_at }}
            
            This is an unofficial build of Aseprite for Linux.
          prerelease: true
          # DON'T skip if exists - we WANT to overwrite/update it
          # skipIfReleaseExists: true  # REMOVE THIS LINE!
          token: ${{ secrets.GITHUB_TOKEN }}
          # Optional: make it a draft if you want more control
          # draft: false

  build-aseprite-linux:
    name: Build Aseprite for Linux
    needs: create-release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      # ... [all your build steps remain the same] ...
      
      - name: Create release archive
        working-directory: aseprite/build/bin
        run: |
          # Include version in filename for clarity
          7z -tzip a Aseprite-${{ needs.create-release.outputs.aseprite-version }}-Linux-Portable.zip *
      
      - name: Upload release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: aseprite/build/bin/Aseprite-${{ needs.create-release.outputs.aseprite-version }}-Linux-Portable.zip
          # Use a clear asset name with version
          asset_name: Aseprite-${{ needs.create-release.outputs.aseprite-version }}-Linux-Portable.zip
          tag: ${{ needs.create-release.outputs.release-tag }}
          # This will overwrite the asset if it already exists with the same name
          overwrite: true
