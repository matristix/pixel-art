  build-aseprite-linux:
    name: Build Aseprite for Linux
    needs: create-release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libpixman-1-dev libfreetype6-dev libharfbuzz-dev zlib1g-dev \
            libx11-dev libxcursor-dev libxi-dev libxrandr-dev libgl1-mesa-dev \
            libfontconfig1-dev \
            wget unzip p7zip-full \
            cmake ninja-build git build-essential ccache
      
      - uses: actions/checkout@v4
      
      - name: Clone Aseprite
        shell: bash
        run: |
          echo "Cloning Aseprite with tag: ${{ needs.create-release.outputs.release-tag }}"
          if [ -d "aseprite" ]; then
            echo "Removing existing aseprite directory"
            rm -rf aseprite
          fi
          git clone --depth 1 --recurse-submodules -j8 https://github.com/aseprite/aseprite.git --branch ${{ needs.create-release.outputs.release-tag }}
      
      - name: Verify Aseprite clone
        shell: bash
        working-directory: aseprite
        run: |
          echo "Current directory: $(pwd)"
          ls -la
          echo "Git tag/branch:"
          git describe --tags || git branch -a
      
      - name: Install Skia for Linux
        shell: bash
        working-directory: aseprite
        run: |
          echo "Downloading Skia..."
          wget -q https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Linux-Release-x64.zip
          echo "Unzipping Skia..."
          unzip -q Skia-Linux-Release-x64.zip -d skia
          echo "Skia contents:"
          ls -la skia/
      
      - name: Configure CMake
        shell: bash
        working-directory: aseprite
        run: |
          echo "Configuring build..."
          mkdir -p build
          
          # Set environment variables
          export CCACHE_DIR="$HOME/.ccache"
          export CCACHE_MAXSIZE="500M"
          
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DENABLE_TESTS=OFF \
            -DENABLE_SCRIPTING=ON \
            -DENABLE_CCACHE=ON \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$(pwd)/skia" \
            -DSKIA_LIBRARY_DIR="$(pwd)/skia/out/Release-x64" \
            -DCMAKE_INSTALL_PREFIX="" \
            -DUSE_SHARED_CMARK=OFF \
            -DUSE_SHARED_CURL=OFF \
            -DUSE_SHARED_GIFLIB=OFF \
            -DUSE_SHARED_JPEGLIB=OFF \
            -DUSE_SHARED_LIBWEBP=OFF \
            -DUSE_SHARED_PIXMAN=OFF \
            -DUSE_SHARED_TINYXML=OFF \
            -DUSE_SHARED_ZLIB=OFF
          
          echo "CMake configuration complete"
      
      - name: Build Aseprite
        shell: bash
        working-directory: aseprite/build
        run: |
          echo "Building with Ninja..."
          ninja -j$(nproc) -v
          echo "Build complete"
          echo "Build directory contents:"
          ls -la
          echo "Bin directory contents:"
          ls -la bin/ || echo "bin directory doesn't exist yet"
      
      - name: Create bin directory if needed
        shell: bash
        working-directory: aseprite
        run: |
          # Ensure bin directory exists
          mkdir -p build/bin
          echo "Checking if aseprite binary was built..."
          if [ -f "build/bin/aseprite" ]; then
            echo "✓ Aseprite binary found"
            ls -lh build/bin/aseprite
          else
            echo "✗ Aseprite binary not found in build/bin/"
            echo "Looking for binary elsewhere..."
            find . -name "aseprite" -type f 2>/dev/null || true
            exit 1
          fi
      
      - name: Copy data files
        shell: bash
        working-directory: aseprite
        run: |
          echo "Copying data files..."
          # Copy the data directory if it exists
          if [ -d "data" ]; then
            cp -r data build/bin/
            echo "Data files copied"
          else
            echo "Warning: data directory not found in aseprite root"
          fi
      
      - name: Clean Up Build folder
        shell: bash
        working-directory: aseprite/build/bin
        run: |
          echo "Current directory: $(pwd)"
          echo "Contents before cleanup:"
          ls -la
          
          # Keep only essential files
          find . -mindepth 1 -maxdepth 1 \
            ! -name 'aseprite' \
            ! -name 'data' \
            ! -name '.' \
            -exec rm -rf {} + 2>/dev/null || true
          
          echo "Contents after cleanup:"
          ls -la
      
      - name: Make portable ini file
        shell: bash
        working-directory: aseprite/build/bin
        run: |
          echo "Creating portable configuration..."
          echo '# This file marks Aseprite as a portable installation' > aseprite.ini
          echo '# Generated: $(date)' >> aseprite.ini
          echo '# Source: ${{ needs.create-release.outputs.release-tag }}' >> aseprite.ini
      
      - name: Create release archive
        shell: bash
        working-directory: aseprite
        run: |
          echo "Creating archive..."
          echo "Working in: $(pwd)"
          echo "Build/bin contents:"
          ls -la build/bin/
          
          # Get version from tag
          VERSION="${{ needs.create-release.outputs.aseprite-version }}"
          if [ -z "$VERSION" ]; then
            VERSION="latest"
          fi
          
          # Create the zip file from the correct location
          cd build/bin
          7z -tzip a ../../Aseprite-${VERSION}-Linux-Portable.zip *
          cd ../..
          
          echo "Archive created:"
          ls -lh Aseprite-*.zip
      
      - name: Upload release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: aseprite/Aseprite-*.zip
          asset_name: Aseprite-${{ needs.create-release.outputs.aseprite-version || 'latest' }}-Linux-Portable.zip
          tag: ${{ needs.create-release.outputs.release-tag }}
          overwrite: true
